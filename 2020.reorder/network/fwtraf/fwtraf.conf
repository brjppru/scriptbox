#!/bin/bash
#----------------------
# Персональные политики
#----------------------

#C IP               NAME              WA  PORTS  [LIMIT]            DESC
#- ---------------  ----------------  --  ------------------------  ---------------------------------------
 a 10.0.250.1       pc113             1   !smtp                     # Компу разрешено всё, кроме SMTP
 a 10.1.114.200     nb124             2   web,pop3 10               # Ноутбук, скорость 10 пакетов в секунду
 a 10.1.114.201     pc115             3   web                       # Только WEB
 a 10.1.118.200     pc12              3   web,smtp,pop3             # Только WEB и почта
 a 10.1.118.201     pc152             2   web,ftp,8888              # Разрешено WEB,FTP, и ещё что-то
 a 10.1.124.202     pc128             3   web,ftp,pop3 50           # Разрешено WEB,FTP и получение почты
 a 10.1.130.200     pc194             3   web,bc_tc 10              # Финансисты, лимит 10 пакетов/секунду
 a 10.1.130.201     pc175             3   web,200,quik,bc_sb        # Финансисты. Quick, Банк-клиент "СберБанк"
 a 10.3.42.37       pc102                                           # Ничего не разрешено, кроме PING,TRACEROUTE
 d 10.3.46.21       pc417             6   all                       # Тупой юзер - запрещаем всё
 a 10.4.36.101      nb11              1   web,ftp,pop3,rdp 10       # Слишком продвинутый юзер - режем скорость
 a 10.5.14.103      pc210             1   all                       # Начальник отдела - открываем всё что можно
 a 10.8.91.202      pc24              2   web,ftp,pop3,oracle       # Программер
 a 10.16.26.207     pc77              3   web,bc_sb,bc_uc           # Банк-клиенты "СберБанк", "ЮникредитБанк"
 A 10.127.255.2     mail                                            # Почтовый сервер - оставляем запись в DNS
 A 10.127.255.2     mx1                                             # Почтовый сервер - оставляем запись в DNS
 a 10.127.255.128   vpn-user          3   rdp,telnet                # VPN-юзер - только RDP и TELNET

#---------------
# Запрещённые IP
#---------------

#C IP               NAME                                                   WA  PORTS     DESC
#- ---------------  -----------------------------------------------------  --  --------  ---------------------------------------
 d 64.233.161.99    google-analytics.com                                   6   all       # Google Spy
 d 72.14.209.99     google-analytics.com                                   6   all       # Google Spy
 d 72.14.253.99     google-analytics.com                                   6   all       # Google Spy
 d 72.14.217.91     sb.l.google.com                                        6   all       # Google Spy
 d 72.14.217.93     bu-in-f93.google.com                                   6   all       # Google Spy
 d 209.85.137.99    mg-in-f99.google.com                                   6   all       # Google Spy
 d 66.249.91.91     kh.l.google.com                                        6   all       # Google

#----------------------------------------------
# Общая политика: разрешённые протоколы и порты
#----------------------------------------------

#C  PROT  PORTS                               [LIMIT]  [CONN_LIMIT]  DESC
#-  ----  ----------------------------------  -------  ------------  -------------------------
 c  udp   dns                                 1000                   # DNS
 c  udp   ntp                                 10                     # NTP
 c  udp   traceroute                          10                     # TRACEROUTE
 c  tcp   fns                                 1000                   # FNS (Федеральная налоговая служба)
 c  udp   bc_sb_udp                           1000                   # BANKCLIENT СберБанка. VPN
 c  tcp   feanor                              100                    # FEANOR
 c  tcp   pptp                                100                    # PPTP
 c  gre   all                                                        # GRE for PPTP
 c  udp   500,4500                            1000                   # CiscoVPN
 e  tcp   openvpn                             1000     10            # OpenVPN
 e  tcp   http,https                          1000                   # HTTP,HTTPS
 i  tcp   http,https                          5000                   # HTTP,HTTPS
 e  tcp   smtp,smtpalt                        5000     5             # SMTP,SMTPALT
 i  tcp   smtp,smtpalt                                               # SMTP,SMTPALT
 e  tcp   pop3,imap                           1000     10            # POP3,IMAP
 i  tcp   pop3,imap                           1000     15            # POP3,IMAP
 e  tcp   ftp                                 1000     10            # FTP
 i  tcp   ftp                                 5000     10            # FTP
 e  tcp   ssh                                 20       10            # SSH
 i  tcp   ssh                                 1000     20            # SSH
 e  tcp   9090                                10       10            # OPENFIRE_CONSOLE
 i  tcp   9090                                10       10            # OPENFIRE_CONSOLE
 i  tcp   webmin,rdp,radmin                   1000     20            # WEBMIN,RDP,RADMIN
 i  udp   tftp                                100                    # TFTP
 i  tcp   smb,rsync                           5000                   # SMB,RSYNC
 i  udp   smb                                 5000                   # SMB
 i  udp   snmp                                20                     # SNMP
 c  tcp   jabber                              50                     # JABBER

#-------------------
# Основные настройки
#-------------------

         EXTIF=""                                                                         # Внешний интерфейс (опр. автоматически, если "")
 EXTDOMAINNAME="domain.com"                                                               # Внешний домен ("", "domain.com")
          LANS="192.168.0.0/24 10.0.0.0/24"                                               # Локальные сети ("xxx.xxx.xxx.xxx/yy")
#  REMOTE_LANS="10.128.0.0/16"                                                            # Удалённые сети ("xxx.xxx.xxx.xxx/yy")
          SNAT="YES"                                                                      # Трансляция адресов на внешний интерфейс ("","YES")
      WEBPROXY=""                                                                         # WEB-прокси ("","SQUID","DGSQUID")
      FTPPROXY=""                                                                         # FTP-прокси ("","FROX")
        REPEML=""                                                                         # Отчеты по почте ("","root","pupkin@mail.ru")
#           GW="192.168.10.254"                                                           # Маршрутизация к сетям через шлюз ("","IP")
#   SNAT_TO_GW="192.168.10.1"                                                             # IP локального интерфейса для SNAT к сетям ("","IP")
#  NETS_VIA_GW="194.84.224.0/26 212.176.66.0/24 212.176.70.0/24"                          # Сети, доступные через шлюз
          sbis="83.242.250.67 83.242.250.68"                                              # СБИС++ - электронная отчетность (порт 25)
         fstrf="87.226.173.3"                                                             # Федеральная служба по тарифам
        feanor="195.135.214.6"                                                            # Феанор
   EMLSERVICES="$sbis $fstrf $feanor"                                                     # Сервисы, использующие порты 25,110
           dc1="173.194.69.0/24"                                                          # Dicter
           tc1="46.182.25.0/24 66.102.13.0/24 74.125.0.0/16 74.125.79.96/28"              # Translate Client
           tc2="74.125.87.96/28 74.125.232.16/29 173.194.32.0/24 174.120.221.88"          # Translate Client
           tc3="207.46.192.223 209.85.146.0/23 209.85.148.0/23 209.85.173.0/24"           # Translate Client
           tc4="209.85.175.0/24 209.85.225.0/24 209.85.227.0/24 209.85.229.100/30"        # Translate Client
          mse1="4.23.0.0/16 64.4.0.0/18 64.209.77.25 65.52.0.0/14 74.125.232.48/30"       # Microsoft Security Essentials
          mse2="77.67.4.0/24 77.67.29.0/24 80.239.224.0/24 80.239.230.0/24"               # Microsoft Security Essentials
          mse3="80.239.254.0/24 92.122.208.112 92.123.69.0/24 94.245.64.0/18"             # Microsoft Security Essentials
          mse4="95.100.131.235 194.221.65.0/26 195.10.0.0/18 207.46.0.0/16"               # Microsoft Security Essentials
          mse5="213.155.154.0/24 213.199.149.98 217.212.252.128/25"                       # Microsoft Security Essentials
            ds="168.75.151.72"                                                            # DraftSight
   WEBSERVICES="$dc1 $tc1 $tc2 $tc3 $tc4 $mse1 $mse2 $mse3 $mse4 $mse5 $ds"               # Сервисы, использующие порты 80,443

#--------
# СПРАВКА
#--------

# Доступные команды:
#   i    PROT PORTS [LIMIT [CONN_LIMIT]] - разрешить трафик из внутренних сетей к заданным портам шлюза, уст. лимиты.
#   e    PROT PORTS [LIMIT [CONN_LIMIT]] - разрешить трафик из внешней    сети  к заданным портам шлюза, уст. лимиты.
#   c    PROT PORTS [LIMIT [CONN_LIMIT]] - разрешить трафик из любых      сетей к заданным портам шлюза и через него, уст. лимиты.
#   [dD] IP   NAME  [WA [PORTS        ]] - прописать в DNS, определить группу WEB-доступа, закрыть tcp/udp-порты.
#   [aA] IP   NAME  [WA [PORTS [LIMIT]]] - прописать в DNS, определить группу WEB-доступа, открыть tcp-порты, уст. лимит.
#   Примечание: Большие буквы D,A - прописать в DNS и перезаписать A-запись во внешнем домене IP-адресом из LAN.
#
# Параметры команд:
#       PROT: (tcp|udp|gre|icmp) - протокол.
#
#      PORTS: p1,..,pN                                   - разрешить порты p1,..,pN (не более 15).
#             p1:p2                                      - разрешить диапазон портов p1-p2.
#             [..,]p1-p2[,..]                            - разрешить порты p1 и p2 и сделать DNAT c EXT_IP:p1 на IP:p2.
#             !p1                                        - разрешить все порты кроме p1.
#             all                                        - разрешить все порты и протоколы.
#             dns,smtp,pop3,imap,smtpstls,pop3tls,eml,   - разрешить порты (не более 15).
#             fns,ftp,gpsmon,http,icq,irc,mssql,ntp,
#             openvpn,oracle,quik,rdp,radmin,sip,smb,
#             snmp,ssh,telnet,torrent,traceroute,web,
#             webinar,webmin,webmoney.
#
#      LIMIT: N  - ограничить скорость N пакетов/сек (2 пак/с=3Кб/с, 5 пак/с=7Кб/с, 10 пак/с=12Кб/с, 30 пак/с=20Кб/с).
#             "" - ограничить скорость Squid`ом.
#
# CONN_LIMIT: 0..20 - ограничить кол-во подключений/мин. Лимит действует для каждого IP отдельно.
#
#         IP: x.x.x.x[/y] - IP-адрес хоста или сети. Если сеть - группа WEB-доступа не применяется.
#
#       NAME: hostname - Имя хоста. Допустимые символы - буквы лат. алфавита, цифры и тире. Точка допускается, но используется
#             в качестве разделителя. Имя kms - служебное, для него будет создана SRV-запись, указывающая на KMS.
#
#         WA: 0..N - Группа фильтрации (WEB-доступ):
#             0 - разрешено всё (фильрация выключена - IP добавлен в exceptioniplist).
#             1 - разрешено всё.
#             2 - разрешено всё кроме скачивания audio/video.
#             3 - полная фильтрация (для простых пользователей).
#             4 - полная фильтрация + запрещены закачки.
#             5 - запрещено всё кроме domain.com,microsoft.com,windowsupdate.com (для серверов).
#             6 - запрещено всё кроме domain.com.
